
<!-- *) 장바구니목록페이지 (장바구니보기 ex:shop-cart-info.php) -->
<!-- AceCounter eCommerce (Cart_Inout) v7.5 Start -->
<!-- Function and Variables Definition Block Start -->
<script language='javascript'>
    var _JV="AMZ2017020801";//script Version
    var _UD='undefined';var _UN='unknown';
    var _ace_countvar = 0;
    function _IDV(a){return (typeof a!=_UD)?1:0}
    var _CRL='http://'+'gtc18.acecounter.com:8080/';
    var _GCD='AS4A42742374057';
    if( document.URL.substring(0,8) == 'https://' ){ _CRL = 'https://gtc18.acecounter.com/logecgather/' ;};
    if(!_IDV(_A_i)) var _A_i = new Image() ;if(!_IDV(_A_i0)) var _A_i0 = new Image() ;if(!_IDV(_A_i1)) var _A_i1 = new Image() ;if(!_IDV(_A_i2)) var _A_i2 = new Image() ;if(!_IDV(_A_i3)) var _A_i3 = new Image() ;if(!_IDV(_A_i4)) var _A_i4 = new Image() ;
    function _RP(s,m){if(typeof s=='string'){if(m==1){return s.replace(/[#&^@,]/g,'');}else{return s.replace(/[#&^@]/g,'');} }else{return s;} };
    function _RPS(a,b,c){var d=a.indexOf(b),e=b.length>0?c.length:1; while(a&&d>=0){a=a.substring(0,d)+c+a.substring(d+b.length);d=a.indexOf(b,d+e);}return a};
    function AEC_F_D(pd,md,cnum){var i=0,amt=0,num=0;var cat='',nm='';num=cnum;md=md.toLowerCase();if(md=='b'||md=='i'||md=='o'){for(i=0;i<_A_pl.length;i++){if(_A_pl[i]==pd){nm=_RP(_A_pn[i]);amt=(parseInt(_RP(_A_amt[i],1))/parseInt(_RP(_A_nl[i],1)))*num;cat=_RP(_A_ct[i]);var _A_cart=_CRL+'?cuid='+_GCD;_A_cart+='&md='+md+'&ll='+_RPS(escape(cat+'@'+nm+'@'+amt+'@'+num+'^&'),'+','%2B');break;};};if(_A_cart.length>0)_A_i.src=_A_cart+"rn="+String(new Date().getTime());setTimeout("",2000);};};
    function AEC_D_A(){ var i = 0,_AEC_str= ''; var ind = 0; for( i = 0 ; i < _A_pl.length ; i ++ ){ _AEC_str += _RP(_A_ct[i])+'@'+_RP(_A_pn[i])+'@'+_RP(_A_amt[i],1)+'@'+_RP(_A_nl[i],1)+'^'; if(  escape(_AEC_str).length > 800 ){ if(ind > 4) ind = 0; _AEC_str = _RPS(escape(_AEC_str),'+','%2B')+'&cmd=on' ; AEC_S_F(_AEC_str , 'o', ind) ; _AEC_str = '' ; ind++; }; }; if( _AEC_str.length > 0 ){ if(ind+1 > 4) ind = 0; AEC_S_F(_RPS(escape(_AEC_str),'+','%2B'), 'o', ind+1) ; }; };
    function AEC_B_A(){var i=0,_AEC_str='',_A_cart='';var ind = 0;_A_cart = _CRL+'?cuid='+_GCD+'&md=b';for( i = 0 ; i < _A_pl.length ; i ++ ){ _AEC_str += ACE_REPL(_A_ct[i])+'@'+ACE_REPL(_A_pn[i])+'@'+ACE_REPL(_A_amt[i],1)+'@'+ACE_REPL(_A_nl[i],1)+'^';if(escape(_AEC_str).length > 800 ){if(ind > 4) ind = 0;_AEC_str = _RPS(escape(_AEC_str),'+','%2B')+'&cmd=on';AEC_S_F(_AEC_str,'b',ind); _AEC_str = '' ;ind++;};}; if( _AEC_str.length > 0 ){if(ind+1 > 4) ind = 0; AEC_S_F(_RPS(escape(_AEC_str),'+','%2B'),'b',ind+1);};};
    function AEC_U_V(pd,bnum){ var d_cnt = 0 ; var A_amt = 0 ; var A_md = 'n' ;var _AEC_str = '' ; for( j = 0 ; j < _A_pl.length; j ++ ){ if( _A_pl[j] == pd ){ d_cnt = 0; if( _A_nl[j] != bnum ){ d_cnt = bnum - parseInt(_RP(_A_nl[j],1)) ; A_amt = Math.round( parseInt(_RP(_A_amt[j],1)) / parseInt(_RP(_A_nl[j],1))); if( d_cnt > 0 ){ A_md = 'i' ; }else{ A_md = 'o' ;};_A_amt[j] = A_amt*Math.abs(d_cnt) ; _A_nl[j] = Math.abs(d_cnt);_AEC_str += _RP(_A_ct[j])+'@'+_RP(_A_pn[j])+'@'+_RP(_A_amt[j],1)+'@'+_RP(_A_nl[j],1)+'^';};};};if( _AEC_str.length > 0 ){ AEC_S_F(_RPS(escape(_AEC_str),'+','%2B') ,A_md, 0);};};
    function AEC_S_F(str,md,idx){var i=0,_A_cart='';var k=eval('_A_i'+idx);if(md=='I')md='i';if(md=='O')md='o';if(md=='B')md='b';if(md=='b'||md=='i'||md=='o'){_A_cart=_CRL+'?cuid='+_GCD;_A_cart+='&md='+md+'&ll='+(str)+'&';k.src=_A_cart+"rn="+String(new Date().getTime());window.setTimeout('',2000);};};
    if(!_IDV(_A_pl)) var _A_pl = Array(1) ;
    if(!_IDV(_A_nl)) var _A_nl = Array(1) ;
    if(!_IDV(_A_ct)) var _A_ct = Array(1) ;
    if(!_IDV(_A_pn)) var _A_pn = Array(1) ;
    if(!_IDV(_A_amt)) var _A_amt = Array(1) ;
</script>
<!-- Function and Variables Definition Block End-->

<div id="contents">
	<div class="cartOrder-page">

		<article class="cart-order-wrap">
			<header class="progess-title">
				<h2>주문/결제</h2>
				<ul class="flow clear">
					<li class="active">
						<div><i></i><span>STEP 1</span>장바구니</div>
					</li>
					<li>
						<div><i></i><span>STEP 2</span>주문하기</div>
					</li>
					<li>
						<div><i></i><span>STEP 3</span>주문완료</div>
					</li>
				</ul>
			</header>
			<!-- 택배배송상품 -->
			<section class="mt-50" id="delivery_type0_section" data-ui="TabMenu">
				{? C.STAFF_YN=='Y'}
				<div class="tabs"> 
					<button type="button" data-content="menu" data-target="normal" class="{=checked(tab_id,'normal','active')}"><span>일반상품(<i id="count_normal">{=number_format(count.normal)}</i>)</span></button>
					<button type="button" data-content="menu" data-target="staff" class="{=checked(tab_id,'staff','active')}"><span>임직원상품(<i id="count_staff">{=number_format(count.staff)}</i>)</span></button>
				</div>
				{/}

				<header class="cart-section-title mt-30">
					<h3><div class="checkbox ml-15"><input type="checkbox" id="check_all" checked><label for="check_all"></label></div>전체선택 (<i id="count_checked">{=number_format(count.normal)}</i>/<i id="count_tab">{=number_format(count.normal)}</i>)</h3>
				</header>

				<!--{* 일반상품:S *}-->
				<div id="inner_normal" class="{=checked(tab_id,'normal','active')}" data-content="content">{=include('./basket/basket.normal.php')}</div> 
				<!--{* 일반상품:E *}-->

				<!--{* 임직원상품:S *}-->
				{? C.STAFF_YN=='Y'}
				<div id="inner_staff" class="{=checked(tab_id,'staff','active')}" data-content="content">{=include('./basket/basket.staff.php')}</div>
				{/}
				<!--{* 임직원상품:E *}-->
				
			</section>
		
		</article><!-- //.cart-order-wrap -->
	</div>
</div><!-- //#contents -->

<script type="text/javascript">
var Basket = {
	tab:'{tab_id}',
	inited:false,
	init: function() {
		var me = this;
		// $('.loading_inner').addClass('loaded');

		$('[data-content="menu"]').on('click.load', function() {
			var tab = $(this).data('target');
			me.tab = tab;
			me.loadTab(tab);
		});

		// 장바구니 > 옵션변경 팝업
		$('.btn_opt_change').click(function () {
			$('.layer_opt_change').show();
			$('html,body').css('overflow-y', 'hidden');
		});

		//전체선택
		$('#check_all').on('click', function() {
			if(this.checked) $('input[name="checked_'+me.tab+'[]"]').prop('checked',true);
			else $('input[name="checked_'+me.tab+'[]"]').prop('checked',false);
			
			me.reloadTab();
		})
		
	},
	qty:function() {
		//TODO 재고, 최대, 최소구매수량체크(임시, 주문단계서 최종체크필요)
		var act = $(this).hasClass("plus")?'plus':'minus';
		var data = $(this).closest('li').data();
		var qty = $(this).siblings('input').val();

		switch(act) {
			case 'plus':
				qty++;
			break;
			case 'minus':
				qty--;
			break;
		}

		//최대구매수량 체크
		if(data.stockMax < qty) {
			UI.warning('최대 '+data.stockMax+'개까지 주문 가능합니다.');
			return false;
		}

		//최소구매수량체크
		if(data.stockMin > qty) {
			UI.warning('최소 '+data.stockMin+'개이상 주문 가능합니다.');
			return false;
		}

		//수량변경처리
		$.ajax({
			url:'/proc/basket.proc.php',
			data:{
				mode:'option',
				act:'qty',
				no:data.basketNo,
				qty:qty

			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					Basket.reloadTab();
				}
				else {
					UI.error(r.msg);
				}
			}
		})
	},
	changeOption:function(group_no) {
		UI.modal('/front/basket/option_add.php','옵션추가', {group_no:group_no});
	},
	loadTab: function(id, reload) {
		
		var id = (typeof id == 'string')?id:Basket.tab;
		var e = $('#inner_'+id);
		var checked = UI.getChecked('checked_'+id+'[]');
	
		var param = {};
		if(reload) {
			if(checked.length > 0) {
				var no = checked.map(function () {return this.value;}).get();
				var param = {no:no.join()};
			}
			else param = {no:''};
		}

		e.load('/front/basket/basket.'+id+'.php',param, function() {
			$(this).addClass('loaded');
			PRODUCT.like(); //좋아요링크연결
			Basket.countTab(); //장바구니 생품개수 리셋

			//전체상품수
			var count_tab = $('[name="checked_'+id+'[]"]').length;
			$('#count_tab, #count_'+id).text(count_tab);
			// $('#count_'+id).text(count_tab);
			
			//선택상품수
			var count_chekced = UI.getChecked('checked_'+id+'[]');
			$('#count_checked').text(count_chekced.length);

			if(count_chekced.length == count_tab) $('#check_all').prop('checked', true);
			else $('#check_all').prop('checked', false);
		});
	},
	reloadTab: function() {
		Basket.loadTab(Basket.tab, true);
	},
	countTab: function() { //장바구니 생품개수 리셋
		var cnt = $('#inner_'+Basket.tab).find('tr[data-no]').length;
		if(cnt.toString().length==1) cnt='0'+cnt.toString();
		$('[data-target="'+Basket.tab+'"]').find('strong').text(cnt);

		var cnt_total = $('tr[data-no]').length;
		$('.icon-curation-cart').text(cnt_total);
	},
	remove: function(no, act, el){
		if(act == 'option') {
			var data = $(el).closest('ul').data();
			if(data.countOption<=1 && data.countProduct>0) {
				UI.confirm('옵션 삭제시 추가구매상품도 함께 삭제됩니다.<br>삭제하시겠습니까?', function() {
					Basket.removeAct(no, act);
				});
			}
			else {
				Basket.removeAct(no, act);
			}
		}
		else {
			Basket.removeAct(no, act);
		}
	},
	removeAct: function(no,act) {
		$.ajax({
			url:'/proc/basket.proc.php',
			data:{
				mode:'remove',
				act:act,
				no:no
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					Basket.reloadTab();
				}
			}
		})
	},
	removeChecked: function() {
		var checked = UI.getChecked('checked_'+this.tab+'[]');
		if(checked.length < 1) {
			UI.error('삭제할 상품을 선택하세요.');
			return false;
		}

		UI.confirm("선택하신 상품을 장바구니에서 삭제하시겠습니까?", function() {
			var no = checked.map(function () {return this.value;}).get();
			Basket.removeAct(no, 'group');
		})
	},
	order: function(no) {
		if(!no) {
			var checked = UI.getChecked('checked_'+this.tab+'[]');
			if(checked.length < 1) {
				UI.error('선택한 상품이 없습니다.');
				return false;
			}
			var no = checked.map(function () {return this.value;}).get();
		}

		var pr_type = (this.tab == 'staff')?'3':'1';
		$.ajax({
			url:'/proc/basket.proc.php',
			data:{
				mode:'order',
				act:'buy_basket',
				pr_type:pr_type,
				no:no
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) document.location.href='/front/'+r.data.url;
				else {
					switch(r.data.error_code) {
						case 'bought':
								UI.confirm(r.msg, function() {
									document.location.href=r.data.url;
								});
								break;
						default:
							UI.warning(r.msg);
							break;
					}
					
				}
			}
		})
	}

}

$(function(){
	Basket.init();
})
	
</script>